services:
  mautrix-telegram-init:
    container_name: mautrix-telegram-init
    image: alpine:latest
    configs:
      - source: telegram-config
        target: /tmp/config.yaml
    volumes:
      - mautrix-telegram-data:/data
    # command: sleep infinityy
    command: |
      sh -c "
        if [ ! -f /data/config.yaml ]; then
          cp /tmp/config.yaml /data/config.yaml
        fi
      "
  mautrix-telegram:
    container_name: mautrix-telegram
    image: dock.mau.dev/mautrix/telegram:latest
    # restart: unless-stopped
    depends_on:
      - mautrix-telegram-init
    volumes:
      - mautrix-telegram-data:/data
      - letsencrypt-certs:/certs
    environment:
      VIRTUAL_PORT: ${VIRTUAL_PORT:-29317}
      VIRTUAL_HOST: ${VIRTUAL_HOST}
      LETSENCRYPT_HOST: ${LETSENCRYPT_HOST}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
      VIRTUAL_PROTO: ${VIRTUAL_PROTO:-https}
      STEP_CA_TRUST: ${STEP_CA_TRUST:-true}
      STEP_CA_TRUST_RESTART: ${STEP_CA_TRUST_RESTART:-true}
    networks:
      - letsencrypt-network
volumes:
  mautrix-telegram-data:
    name: mautrix-telegram-data
  step-ca-certs:
    name: step-ca-certs
    external: true
  letsencrypt-certs:
    name: letsencrypt-certs
    external: true
configs:
  telegram-config:
    content: |-
      homeserver:
        address: ${MATRIX_TELEGRAM_HOMESERVER}
        domain: ${MATRIX_TELEGRAM_DOMAIN}
        verify_ssl:verify_ssl: ${MATRIX_TELEGRAM_VERIFY_SSL:-true}
      appservice:
        address: ${MATRIX_TELEGRAM_APPSERVICE_ADDRESS}
        tls_cert: ${MATRIX_TELEGRAM_APPSERVICE_TLS_CERT:-false}
        tls_key: ${MATRIX_TELEGRAM_APPSERVICE_TLS_KEY:-false}
        hostname: ${MATRIX_TELEGRAM_APPSERVICE_HOSTNAME:-"0.0.0.0"}
        port: ${MATRIX_TELEGRAM_APPSERVICE_PORT:-29317}
        database: ${MATRIX_TELEGRAM_APPSERVICE_DATABASE:-"sqlite:////data/mautrix-telegram.db"}
        id: ${MATRIX_TELEGRAM_APPSERVICE_ID:-telegram}
        bot_username: ${MATRIX_TELEGRAM_APPSERVICE_BOT_USERNAME:-telegrambot}
        bot_displayname: ${MATRIX_TELEGRAM_APPSERVICE_BOT_DISPLAYNAME:-"Telegram Bridge bot"}
        bot_avatar: ${MATRIX_TELEGRAM_APPSERVICE_BOT_AVATAR}
      telegram:
        api_id: ${MATRIX_TELEGRAM_API_ID}
        api_hash: ${MATRIX_TELEGRAM_API_HASH}
        bot_token: ${MATRIX_TELEGRAM_BOT_TOKEN:-disabled}
      bridge:
        username_template: ${MATRIX_TELEGRAM_BRIDGE_USERNAME_TEMPLATE:-telegram_{userid}}
        displayname_template: "${MATRIX_TELEGRAM_BRIDGE_DISPLAYNAME_TEMPLATE:-"{displayname} (Telegram)"}"
        startup_sync: ${MATRIX_TELEGRAM_BRIDGE_STARTUP_SYNC:-true}
        sync_direct_chats: ${MATRIX_TELEGRAM_BRIDGE_SYNC_DIRECT_CHATS:-true}
        sync_create_limit: ${MATRIX_TELEGRAM_BRIDGE_SYNC_CREATE_LIMIT:-0}
        backfill:
          enable: ${MATRIX_TELEGRAM_BRIDGE_BACKFILL_ENABLE:-false}
        permissions:
          "${MATRIX_TELEGRAM_DOMAIN}": ${MATRIX_TELEGRAM_BRIDGE_PERMISSIONS_USERS:-puppeting}
networks:
  letsencrypt-network:
    external: true
